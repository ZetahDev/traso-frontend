---
import { FORM_LABELS } from '@lib/constants';
---

<form id="votanteForm">
  <div class="form-row">
    <div class="form-group">
      <label for="votante_nombre"
        >{FORM_LABELS.votante_nombre} <span class="required">*</span></label
      >
      <input type="text" id="votante_nombre" name="nombre" required />
    </div>
    <div class="form-group">
      <label for="votante_dni"
        >{FORM_LABELS.votante_dni}
        <span class="optional">(opcional)</span></label
      >
      <input type="text" id="votante_dni" name="dni" />
    </div>
    <div class="form-group">
      <label for="votante_edad"
        >{FORM_LABELS.votante_edad}
        <span class="optional">(opcional)</span></label
      >
      <input type="number" id="votante_edad" name="edad" min="18" max="100" />
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="votante_telefono"
        >{FORM_LABELS.votante_telefono} <span class="required">*</span></label
      >
      <input type="tel" id="votante_telefono" name="telefono" required />
    </div>
    <div class="form-group">
      <label for="votante_lider"
        >{FORM_LABELS.votante_lider} <span class="required">*</span></label
      >
      <select id="votante_lider" name="lider_id" required>
        <option value="">Sin asignar</option>
      </select>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="votante_mesa"
        >{FORM_LABELS.votante_mesa}
        <span class="optional">(opcional)</span></label
      >
      <input type="text" id="votante_mesa" name="mesa_sufragio" />
    </div>
    <div class="form-group">
      <label for="votante_local"
        >{FORM_LABELS.votante_local}
        <span class="optional">(opcional)</span></label
      >
      <input type="text" id="votante_local" name="local_votacion" />
    </div>
  </div>

  <button type="submit">üìù Registrar Votante</button>
</form>

<script>
  import { votantesAPI, lideresAPI } from '@lib/api';
  import { MESSAGES } from '@lib/constants';

  async function loadLideresForSelect() {
    try {
      const lideres = await lideresAPI.getAll();
      const select = document.getElementById(
        'votante_lider',
      ) as HTMLSelectElement;
      if (select) {
        select.innerHTML = '<option value="">Sin asignar</option>';
        lideres.forEach((lider) => {
          const option = document.createElement('option');
          option.value = lider.id;
          const dniText = lider.dni ? ` (${lider.dni})` : '';
          option.textContent = `${lider.nombre}${dniText}`;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading lideres:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('votanteForm') as HTMLFormElement;

    loadLideresForSelect();

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const data: any = {};

      for (let [key, value] of formData.entries()) {
        if (typeof value === 'string' && value.trim() !== '') {
          data[key] = value.trim();
          if (key === 'edad') {
            data[key] = parseInt(value);
          }
        }
      }

      try {
        await votantesAPI.create(data);
        (window as any).showMessage(
          MESSAGES.success.votante_created,
          'success',
        );
        form.reset();
        window.dispatchEvent(new CustomEvent('loadVotantes'));
      } catch (error: any) {
        (window as any).showMessage(
          error.message || MESSAGES.error.create_votante,
          'error',
        );
      }
    });

    window.addEventListener('loadVotantes', () => {
      loadLideresForSelect();
    });
  });
</script>
